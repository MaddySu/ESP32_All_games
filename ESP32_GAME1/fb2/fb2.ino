#include <Wire.h>
#include <SPI.h>
#include <Adafruit_GFX.h>
#include <Adafruit_SH110X.h>

#define SCREEN_WIDTH 128 // OLED display width, in pixels
#define SCREEN_HEIGHT 64 // OLED display height, in pixels
// Define the pin for the button
#define BUTTON_PIN 4

#define OLED_MOSI   9
#define OLED_CLK    10
#define OLED_DC     11
#define OLED_CS     12
#define OLED_RESET 13

Adafruit_SH1106G display = Adafruit_SH1106G(128, 64, &Wire, OLED_RESET);

//Adafruit_SH1106G display(SCREEN_WIDTH, SCREEN_HEIGHT, &Wire, OLED_RESET);

#define YT_BMPWIDTH  128 // Replace with the actual width of your bitmap
#define YT_BMPHEIGHT 56 // Replace with the actual height of your bitmap

const unsigned char bitmap_YT[] PROGMEM = { 
  
  0x00,0x00,0x00,0xC0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00, // ........................##......................................................................................................
  0x00,0x00,0x01,0xE0,0x00,0x00,0x00,0x01,0xE0,0x00,0x00,0x00,0x00,0x00,0x00,0x00, // .......................####....................................####.............................................................
  0x00,0x00,0x03,0xE0,0x00,0x00,0x00,0x01,0xF0,0x00,0x00,0x00,0x00,0x00,0x00,0x00, // ......................#####....................................#####............................................................
  0x00,0x00,0x03,0xE0,0x00,0x00,0x00,0x01,0xF0,0x00,0x00,0x00,0x00,0x00,0x00,0x00, // ......................#####....................................#####............................................................
  0x00,0x00,0x01,0xF0,0x00,0x00,0x00,0x01,0xF0,0x00,0x00,0x00,0x00,0x00,0x00,0x00, // .......................#####...................................#####............................................................
  0x00,0x00,0x00,0x18,0x03,0xFF,0xC0,0x02,0xE0,0x00,0x00,0x00,0x00,0x00,0x00,0x00, // ...........................##.........############............#.###.............................................................
  0x00,0x00,0x00,0x0C,0x1F,0xFF,0xF8,0x04,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00, // ............................##.....##################........#..................................................................
  0x00,0x00,0x00,0x04,0x7F,0xFF,0xFE,0x08,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00, // .............................#...######################.....#...................................................................
  0x00,0x00,0x00,0x03,0xFF,0xFF,0xFF,0x90,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00, // ..............................###########################..#....................................................................
  0x00,0x00,0x00,0x03,0xFF,0xFF,0xFF,0xF0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00, // ..............................##############################....................................................................
  0x00,0x00,0x00,0x07,0xFF,0xFF,0xFF,0xE0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00, // .............................##############################.....................................................................
  0x00,0x00,0x00,0x0F,0xFF,0xFF,0xFF,0xF0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00, // ............................################################....................................................................
  0x00,0x00,0x00,0x1F,0xFF,0xFF,0xFF,0xF8,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00, // ...........................##################################...................................................................
  0x00,0x00,0x00,0x3F,0xFF,0xFF,0xFF,0xFC,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00, // ..........................####################################..................................................................
  0x00,0x00,0x00,0x40,0xFF,0xFF,0xFF,0x80,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00, // .........................#......#########################.......................................................................
  0x00,0x00,0x00,0x00,0x3F,0xFF,0xFE,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00, // ..................................#####################.........................................................................
  0x07,0xF8,0x00,0x7F,0x8F,0xFF,0xF8,0x7F,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00, // .....########............########...#################....#######................................................................
  0x3F,0xFF,0x81,0xFF,0xE0,0x00,0xF3,0xFF,0xC0,0x00,0x00,0x00,0x00,0x00,0x00,0x00, // ..###############......############.............####..############..............................................................
  0x7F,0xFF,0xE3,0xFF,0xF3,0xFE,0x07,0xFF,0xE0,0x00,0x1F,0xFF,0xFF,0x0F,0xFF,0xF8, // .##################...##############..#########......##############................#####################....#################...
  0x60,0x01,0xF7,0xC1,0xFF,0xFF,0x8F,0xC1,0xFF,0xFF,0xFF,0xFF,0xFF,0xDF,0xFF,0xF8, // .##............#####.#####.....##################...######.....###########################################.##################...
  0x60,0x00,0x7F,0x00,0x7F,0xFF,0xFF,0x00,0x7F,0xFF,0xFC,0x1C,0x01,0xFC,0x00,0x08, // .##..............#######.........#######################.........#####################.....###.........#######..............#...
  0x60,0x00,0x3E,0x00,0x1C,0x00,0xFE,0x00,0x3C,0x04,0x38,0x0C,0x00,0x7C,0x00,0x18, // .##...............#####............###..........#######...........####.......#....###.......##...........#####.............##...
  0x60,0x00,0x1C,0x78,0x0C,0x00,0x3C,0x0F,0x1C,0x04,0x08,0x0C,0x00,0x1C,0x00,0x18, // .##................###...####.......##............####......####...###.......#......#.......##.............###.............##...
  0x20,0x00,0x1C,0xFE,0x0C,0x00,0x18,0x3F,0xCC,0x04,0x18,0x0C,0x00,0x0C,0x00,0x30, // ..#................###..#######.....##.............##.....########..##.......#.....##.......##..............##............##....
  0x20,0x00,0x19,0xFF,0x04,0x00,0x18,0x7F,0xCC,0x00,0x18,0x0C,0x00,0x0C,0x00,0x30, // ..#................##..#########.....#.............##....#########..##.............##.......##..............##............##....
  0x20,0x00,0x1B,0xFF,0x84,0x00,0x10,0x7F,0xEC,0x00,0x38,0x0C,0x00,0x04,0x00,0x60, // ..#................##.###########....#.............#.....##########.##............###.......##...............#...........##.....
  0x20,0x10,0x1B,0xFF,0x84,0x04,0x10,0xFF,0xE4,0x00,0x38,0x0C,0x00,0x04,0x00,0x60, // ..#........#.......##.###########....#.......#.....#....###########..#............###.......##...............#...........##.....
  0x20,0x1C,0x13,0xFF,0x84,0x06,0x10,0xFF,0xF4,0x00,0x78,0x0C,0x06,0x07,0xC0,0xC0, // ..#........###.....#..###########....#.......##....#....############.#...........####.......##.......##......#####......##......
  0x20,0x1C,0x13,0xFF,0x82,0x06,0x30,0xFF,0xF4,0x00,0xF8,0x0C,0x07,0x07,0xC0,0xC0, // ..#........###.....#..###########.....#......##...##....############.#..........#####.......##.......###.....#####......##......
  0x20,0x18,0x3B,0xF7,0x86,0x00,0x30,0xFF,0xF6,0x00,0xFC,0x0E,0x07,0x87,0x81,0xC0, // ..#........##.....###.######.####....##...........##....############.##.........######......###......####....####......###......
  0x20,0x00,0x7B,0xE7,0x86,0x00,0x70,0xFC,0xE6,0x01,0xFC,0x0E,0x07,0x87,0x81,0x80, // ..#..............####.#####..####....##..........###....######..###..##........#######......###......####....####......##.......
  0x20,0x00,0xFB,0xF7,0x86,0x04,0x70,0x7C,0xEE,0x00,0xFC,0x1E,0x07,0x0F,0x81,0xE0, // ..#.............#####.######.####....##......#...###.....#####..###.###.........######.....####......###....#####......####.....
  0x30,0x01,0xF9,0xFF,0x06,0x0E,0x38,0x7F,0xCE,0x00,0x7C,0x1E,0x07,0x0F,0x83,0xF0, // ..##...........######..#########.....##.....###...###....#########..###..........#####.....####......###....#####.....######....
  0x30,0x00,0xFC,0xFE,0x0E,0x04,0x38,0x3F,0xDE,0x08,0x3C,0x1E,0x06,0x0F,0x03,0xF0, // ..##............######..#######.....###......#....###.....########.####.....#.....####.....####......##.....####......######....
  0x30,0x10,0x7E,0x7C,0x1E,0x00,0x7C,0x0F,0x1E,0x0C,0x1C,0x1E,0x00,0x1F,0x00,0x30, // ..##.......#.....######..#####.....####..........#####......####...####.....##.....###.....####............#####..........##....
  0x30,0x10,0x3E,0x00,0x3E,0x00,0xFE,0x00,0x3E,0x0C,0x7C,0x1E,0x00,0x3F,0x00,0x60, // ..##.......#......#####...........#####.........#######...........#####.....##...#####.....####...........######.........##.....
  0x30,0x18,0x7F,0x80,0x7F,0xFF,0xEF,0x00,0x7F,0xFF,0xFF,0xFE,0x00,0xFE,0x00,0x60, // ..##.......##....########........##################.####.........##############################.........#######..........##.....
  0x3F,0xFD,0xFF,0xF3,0xFF,0xFF,0xCF,0xF3,0xFF,0xFF,0xDF,0xFF,0xFF,0xEF,0xFF,0xE0, // ..############.#############..####################..########..####################.########################.###############.....
  0x1F,0xFF,0xF3,0xFF,0xF1,0xFE,0x03,0xFF,0xE0,0x0F,0x00,0x0F,0xFF,0x8F,0xFF,0xC0, // ...#################..##############...########.......#############.........####............#############...##############......
  0x0F,0xFF,0xC1,0xFF,0xC0,0x00,0x71,0xFF,0xC0,0x00,0x00,0x03,0xFC,0x00,0x00,0x00, // ....##############.....###########...............###...###########............................########..........................
  0x00,0x03,0x00,0x7F,0x8F,0xFF,0xF8,0x7F,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00, // ..............##.........########...#################....#######................................................................
  0x00,0x00,0x00,0x00,0x3F,0xFF,0xFE,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00, // ..................................#####################.........................................................................
  0x00,0x00,0x00,0x41,0xFF,0xFF,0xFF,0x80,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00, // .........................#.....##########################.......................................................................
  0x00,0x00,0x00,0x7F,0xFF,0xFF,0xFF,0xFE,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00, // .........................######################################.................................................................
  0x00,0x00,0x00,0x3F,0xFC,0x00,0x7F,0xFC,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00, // ..........................############...........#############..................................................................
  0x00,0x00,0x00,0x3F,0xFE,0x00,0x7F,0xFC,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00, // ..........................#############..........#############..................................................................
  0x00,0x00,0x00,0x3F,0xFF,0x81,0xFF,0xFC,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00, // ..........................###############......###############..................................................................
  0x00,0x00,0x00,0x1F,0xFF,0xEF,0xFF,0xF8,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00, // ...........................################.#################...................................................................
  0x00,0x00,0x00,0x0F,0xFF,0xFF,0xFF,0xF0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00, // ............................################################....................................................................
  0x00,0x00,0x00,0x03,0xFF,0xFF,0xFF,0xC0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00, // ..............................############################......................................................................
  0x00,0x00,0x00,0x00,0xFF,0xFF,0xFF,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00, // ................................########################........................................................................
  0x00,0x00,0x00,0x00,0x3F,0xFF,0xF8,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00, // ..................................###################...........................................................................
  0x00,0x00,0x00,0x00,0x07,0xFF,0xE0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00, // .....................................##############.............................................................................
  0x00,0x00,0x00,0x00,0x01,0xFF,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00, // .......................................#########................................................................................
  0x00,0x00,0x00,0x00,0x00,0x7C,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00, // .........................................#####..................................................................................
  0x00,0x00,0x00,0x00,0x00,0x10,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00  // ...........................................#....................................................................................

};


// Game variables
float birdY;
float birdVelocity;
const float gravity = 0.3;  // Gravity affecting the bird
const float lift = -3;      // The lift force when the button is pressed (bounciness)
int score;
bool gameStarted;
bool gameOver;

const int pipeWidth = 8;
const int pipeGap = 30;
float pipeX;
float pipeGapY;

unsigned long lastButtonPress = 0;
const unsigned long debounceDelay = 50;

void setup() {
  Serial.begin(115200);

  // Initialize display
  display.begin(0x3c, true); // initialize with the I2C addr 0x3c
    display.drawBitmap(
    (display.width()  - YT_BMPWIDTH ) / 2,
    (display.height() - YT_BMPHEIGHT) / 2,
    bitmap_YT, YT_BMPWIDTH, YT_BMPHEIGHT, 1);
  // display.display();
  // display.display(); // show splashscreen
    display.clearDisplay();
  display.drawBitmap(0, 0, bitmap_YT, 128, 56, FWRITE);
  display.display();
  delay(4000);
  display.clearDisplay();

  // Initialize button pin
  pinMode(BUTTON_PIN, INPUT_PULLUP);

  // Initialize game variables
  resetGame();
}

void drawBird() {
  display.fillCircle(20, birdY, 3, SH110X_WHITE);
}

void drawPipe() {
  display.fillRect(pipeX, 0, pipeWidth, pipeGapY, SH110X_WHITE);
  display.fillRect(pipeX, pipeGapY + pipeGap, pipeWidth, display.height() - pipeGapY - pipeGap, SH110X_WHITE);
}

void resetGame() {
  birdY = display.height() / 2;
  birdVelocity = 0;
  score = 0;
  pipeX = display.width();
  pipeGapY = random(10, display.height() - pipeGap - 10);
  gameStarted = false;
  gameOver = false;
}

bool isButtonPressed() {
  if (digitalRead(BUTTON_PIN) == LOW) {
    unsigned long currentTime = millis();
    if (currentTime - lastButtonPress > debounceDelay) {
      lastButtonPress = currentTime;
      return true;
    }
  }
  return false;
}

void loop() {
  // Clear the display
  display.clearDisplay();

  if (!gameStarted) {
    display.setCursor(2, 20);
    display.setTextSize(1);
    display.setTextColor(SH110X_WHITE);
    display.print("Press button to start");

    //drawBird(); // Draw the bird in the initial position

    if (isButtonPressed()) {
      gameStarted = true;
      birdVelocity = lift; // Start the game with an initial lift
    }
  } else if (gameOver) {
    display.setCursor(10, 20);
    display.setTextSize(1);
    display.setTextColor(SH110X_WHITE);
    display.print("Game Over!");
    display.setCursor(10, 30);
    display.print("Press to restart");

    if (isButtonPressed()) {
      resetGame();
    }
  } else {
    if (isButtonPressed()) {
      birdVelocity = lift; // Apply lift when button is pressed
    }

    birdVelocity += gravity; // Apply gravity
    birdY += birdVelocity; // Update bird position

    // Move pipe
    pipeX -= 2;
    if (pipeX < -pipeWidth) {
      pipeX = display.width();
      pipeGapY = random(10, display.height() - pipeGap - 10);
      score++;
    }

    // Check for collision
    if (birdY - 3 < 0 || birdY + 3 > display.height() || 
        (birdY - 3 < pipeGapY && pipeX < 20 && pipeX + pipeWidth > 20) ||
        (birdY + 3 > pipeGapY + pipeGap && pipeX < 20 && pipeX + pipeWidth > 20)) {
      gameOver = true;
    }

    drawBird();
    drawPipe();

    display.setCursor(0, 0);
    display.setTextSize(1);
    display.setTextColor(SH110X_WHITE);
    display.print("Score: ");
    display.print(score);
  }

  display.display();
}
